<!DOCTYPE html>
<html>
<!--

Copyright (c) 2011 House of Life Property ltd.
Copyright (c) 2011 Crystalnix <vgachkaylo@crystalnix.com>

-->
<head>
<meta name="google" value="notranslate">
<title>Uncensor Filter background page</title>
<!--
<script src="chrome://resources/js/cr.js"></script>
<script src="chrome://resources/js/cr/event_target.js"></script>
-->
<script type="text/javascript" src="parseuri.js"></script>
<script type="text/javascript">
  String.prototype.endsWith = function(suffix) {
      return this.indexOf(suffix, this.length - suffix.length) !== -1;
  };

  var up = chrome.experimental.contentSettings.misc.uncensorPrefs;
  var prefs = null;
  
  /**
   * Returns whether the |levelOfControl| means that the extension can change the
   * preference value.
   *
   * @param levelOfControl{string}
   */
  function settingIsControllable(levelOfControl) {
    return (levelOfControl == "ControllableByThisExtension" ||
            levelOfControl == "ControlledByThisExtension");
  }
  
  function downloadFilterData() {
    prefs.domainFilter = {
      "google.ru": "google.com",
      "torrents.ru": "rutracker.org",
      "torrentfinder.com": "torrentfinder.info",
      "re1ease.net": "scrrls.net",
      "1a": "a",
      "1b": "a",
      "1c": "a",
      "1d": "a",
      "1e": "a",
      "1f": "a",
      "1g": "a",
      "1h": "a",
      "1i": "a",
    };
    
    up.set({ 'value': JSON.stringify(prefs) });
  }
  
  function firstInitPrefs() {
    prefs = {};
    prefs.shouldRedirect = true;
    prefs.showMessage = true;
    prefs.notifyUpdate = true;
    prefs.domainFilter = {};
    prefs.domainExceptions = {};
    
    up.set({ 'value': JSON.stringify(prefs) });
  }
  
  
  up.get({}, function (details) {
    if (settingIsControllable(details.levelOfControl)) {
      if (details.value == "") {
        firstInitPrefs();
        downloadFilterData();
      }
      else {
        prefs = JSON.parse(details.value);
      }
    }
  });
  
  up.onChange.addListener(function (details) {
    if (settingIsControllable(details.levelOfControl)) {
      if (details.value != "")
        prefs = JSON.parse(details.value);
    }
  });
  
  var recent = {};
  recent.tabId = -1;
  recent.url = "";
  recent.timestamp = 0;
  
  // Called when the url of a tab changes.
  function redirectListener(tabId, changeInfo, tab) {
    if (!prefs || !prefs.shouldRedirect)
      return;
      
    var uri = parseUri(tab.url);
    for (var domain in prefs.domainFilter) {
      if (uri["host"].endsWith(domain)) {
        // in the next line, it will replace only first occurence of host string
        var newUri = tab.url.replace(domain, prefs.domainFilter[domain]);
                    
        chrome.tabs.update(tabId, {"url": newUri});
        if (prefs.showMessage &&
            !(tabId == recent.tabId && tab.url == recent.url && (Date.now() - recent.timestamp) < 500)
           ) {
          var notification = webkitNotifications.createNotification(
            '48uncensor.png',  // icon url - can be relative
            'Uncensor filter',  // notification title
            'You are being redirected to ' + newUri  // notification body text
          );
          notification.show();

          setTimeout(function() {
            notification.cancel();
          }, 5000);
        }
        
        recent.tabId = tabId;
        recent.url = tab.url;
        recent.timestamp = Date.now();
      }
    }
  };

  // Listen for any changes to the URL of any tab.
  chrome.tabs.onUpdated.addListener(redirectListener);
</script>
</head>
</html>
