<!DOCTYPE html>
<html>
<!--

Copyright (c) 2011 House of Life Property ltd.
Copyright (c) 2011 Crystalnix <vgachkaylo@crystalnix.com>

-->
<head>
<meta name="google" value="notranslate">
<title>Uncensor Filter background page</title>

<script type="text/javascript" src="parseuri.js"></script>
<script type="text/javascript">
  String.prototype.endsWith = function(suffix) {
      return this.indexOf(suffix, this.length - suffix.length) !== -1;
  };

  var up = chrome.experimental.contentSettings.misc.uncensorPrefs;
  var prefs = null;
  
  /**
   * Returns whether the |levelOfControl| means that the extension can change the
   * preference value.
   *
   * @param levelOfControl{string}
   */
  function settingIsControllable(levelOfControl) {
    return (levelOfControl == "ControllableByThisExtension" ||
            levelOfControl == "ControlledByThisExtension");
  }
  
  function downloadFilterData() {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
      if (xhr.readyState == 4) {
        var d = JSON.parse(xhr.responseText);
        var changed = false;
        var od = {};
        for (var x in d) {
          od[d[x]['srcDomain']] = d[x]['dstDomain'];
          if (!(d[x]['srcDomain'] in prefs.domainFilter))
            changed = true;
        }
      
        for (var x in prefs.domainFilter)
          if (!x in od)
            changed = true;
      
        if (changed) {
          var notification = webkitNotifications.createNotification(
            '48uncensor.png',  // icon url - can be relative
            'Uncensor filter',  // notification title
            'The uncensor domain list was updated successfully.'  // notification body text
          );
          notification.show();
          setTimeout(function() {
            notification.cancel();
          }, 5000);
        }
      
        prefs.domainFilter = od;
        
        for (var excDomain in prefs.domainExceptions) {
          if (!(excDomain in prefs.domainFilter)) {
            delete prefs.domainExceptions[excDomain];
          }
        }
        
        prefs.lastUpdate = Date.now();
        up.set({ 'value': JSON.stringify(prefs) });
      }
    };
    xhr.open("GET", 'http://tools.bitpop.com/service/uncensor_domains', true);
    xhr.send();
  }

  function firstInitPrefs() {
    prefs = {};
    prefs.shouldRedirect = true;
    prefs.showMessage = true;
    prefs.notifyUpdate = true;
    prefs.domainFilter = {};
    prefs.domainExceptions = {};
    prefs.lastUpdate = 0;
    
    up.set({ 'value': JSON.stringify(prefs) });
  }
  
  function checkAndUpdate() {
    if (Date.now() - prefs.lastUpdate > 1000 * 60 * 60 * 24)
      downloadFilterData();
    setTimeout("checkAndUpdate()", 1000 * 60 * 60);
  }
  
  up.get({}, function (details) {
    if (details.value != "") {
      prefs = JSON.parse(details.value);
    } else {
      firstInitPrefs();
    }
    checkAndUpdate();
  });
  
  up.onChange.addListener(function (details) {
    if (details.value != "")
      prefs = JSON.parse(details.value);
  });
  
  var recent = {};
  recent.tabId = -1;
  recent.url = "";
  
  // Called when the url of a tab changes.
  function redirectListener(tabId, changeInfo, tab) {
    if (!prefs || !prefs.shouldRedirect)
      return;
      
    var uri = parseUri(tab.url);
    for (var domain in prefs.domainFilter) {
      if (!(domain in prefs.domainExceptions) && uri["host"].endsWith(domain) && 
          prefs.showMessage && changeInfo.status == "loading") {
        
        uri['host'] = uri['host'].replace(new RegExp(domain+'$', ''), prefs.domainFilter[domain]);
        var newUri = reconstructUri(uri);
        chrome.tabs.update(tabId, {"url": newUri});
          
        var notification = webkitNotifications.createNotification(
          '48uncensor.png',  // icon url - can be relative
          'Uncensor filter',  // notification title
          'You are being redirected to ' + newUri  // notification body text
        );
        notification.show();

        setTimeout(function() {
          notification.cancel();
        }, 5000);
      }
    }
  };

  // Listen for any changes to the URL of any tab.
  chrome.tabs.onUpdated.addListener(redirectListener);
</script>
</head>
</html>
