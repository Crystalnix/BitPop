<html>
<head>
  <title>Facebook Connect For Chrome Extension</title>
  <script>
      var appId = "190635611002798";
      var successURL = 'http://www.facebook.com/connect/login_success.html';
      var friendsCallback = null;
      // Facebook error codes
      var FB = {
        API_EC_PARAM_ACCESS_TOKEN: 190
      };
      var friendsCached = null;
      var friendsLastUpdateTime = 0;

      chrome.browserAction.setIcon({ path: "facebook_icon.png" });
      chrome.browserAction.setTitle({ title: "Facebook chat" });

      chrome.tabs.onUpdated.addListener(onFacebookLogin);

      function onFacebookLogin(tabId, changeInfo, tab) {
        if (!localStorage.accessToken || localStorage.invalidToken) {
          if (changeInfo.url && changeInfo.url.indexOf(successURL) == 0) {
            var params = changeInfo.url.split('#');
            if (params.length > 1) {
              var paramsArray = params[1].split('&');
              for (var j in paramsArray) {
                var paramTuple = paramsArray[j].split('=');
                if (paramTuple[0] == 'access_token') {
                  localStorage.invalidToken = false;
                  localStorage.accessToken = paramTuple[1];
                  chrome.extension.sendRequest(
                      { requestType: "serviceAvailable" });
                  break;
                }
              }
            }
            else {
              localStorage.clear();
              chrome.extension.sendRequest({ requestType: 'loggedOut' });
            }

            chrome.tabs.remove(tabId);
          }
        }
      }
      
      function openAuthWindow(appId, redirectUri) {
        var url = "https://www.facebook.com/dialog/oauth?client_id=" + appId +
            "&response_type=token&redirect_uri=" + redirectUri + 
            '&display=popup' +
            '&scope=xmpp_login,offline_access,' +
              'user_online_presence,friends_online_presence';
              
        window.open(url, 'facebookAuthWindow',
            'height=580,width=400,toolbar=no,directories=no,status=no,' +
            'menubar=no,scrollbars=no,resizable=no,modal=yes');
      }

      chrome.extension.onRequest.addListener(function (request, sender, sendResponse) {
        if (!request.requestType)
          return;

        if (request.requestType == 'getFriendList') {
          if (Date.now() - friendsLastUpdateTime >= 1 * 60 * 1000 || 
              !friendsCached) 
            getFriendList();
          else
            friendListSent(friendsCached);
        }
        else if (request.requestType == 'setAccessToken') {
          localStorage.accessToken = request.accessToken;
          sendResponse.call(window);
          chrome.extension.sendRequest({ requestType: "serviceAvailable" });
        }
        else if (request.requestType == 'login') {
          openAuthWindow(appId, successURL);
        }
        else if (request.requestType == 'loggedOut') {
          
        }
      });

      function getFqlQueryUrl(query) {
        var fqlUrl = 'https://api.facebook.com/method/fql.query?query=' +
              escape(query) + '&format=json' +
              '&access_token=' + localStorage.accessToken;
        return fqlUrl;
      }

      function friendListSent(obj) {
        chrome.extension.sendRequest({ requestType: 'sentFriendList', 
                                       data: obj });
      }

      function getFriendList() {
        if (!localStorage.accessToken) {
          // send error through callback
          friendListSent({ error: 'Not authenticated to use' +
                                         ' Facebook services.' });
        }

        var friendListQuery = 
            'SELECT uid, name, pic_square, online_presence' +
            ' FROM user WHERE uid IN' +
            ' (SELECT uid2 FROM friend WHERE uid1=me())';

        try {
          var req = new XMLHttpRequest();
          req.onreadystatechange = function () {
            if (req.readyState == 4) {
              if (req.status == 200) {
                resp = JSON.parse(req.responseText);
                if ('error_code' in resp) { // handle error first
                  var param = {};
                  param.error = 'FQL query failed: ' +
                    '(' + resp.error_code + ') ' +
                    (resp.error_msg ? resp.error_msg : 'No info.');
                  if (resp.error_code == FB.API_EC_PARAM_ACCESS_TOKEN) {
                    param.waitForService = true;
                    localStorage.invalidToken = true;
                    openAuthWindow(appId, successURL);
                  }

                  friendListSent(param);
                }
                else {
                  // return result, success
                  friendListSent(resp);
                  friendsCached = resp;
                  friendsLastUpdateTime = Date.now();
                }
              }
              else {
                friendListSent({ error: 'There was a problem' +
                      ' retrieving the data: ' + req.statusText });
              }

              req = null;
            }
          };
          req.open("GET", getFqlQueryUrl(friendListQuery), true);
          req.send(null);
        }
        catch(e) {
          // send error through callback
          friendListSent({ error: 'Can\'t connect to server: ' +
                            e.toString() });
        }
      }
 </script>
</head>
</html>
