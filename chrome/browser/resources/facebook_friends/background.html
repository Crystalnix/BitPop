<html>
<head>
  <title>Facebook Connect For Chrome Extension</title>

  <script>
    // constants =========================================
    var boshServerURL = "http://tools.bitpop.com:5280";
    var appId = "190635611002798";
    var successURL = 'http://www.facebook.com/connect/login_success.html';
    var facebookAPIURL = 'https://graph.facebook.com';
    // Facebook error codes
    var FB = {
      API_EC_PARAM_ACCESS_TOKEN: 190
    };
  </script>
  <script src="js/jquery.min.js"></script>
  <script src="js/strophe.min.js"></script>
  <script src="js/facebook.js"></script>
  <script src="js/autolink-min.js"></script>
  <script src="js/common.js"></script>
  <script>
      var friendsCallback = null;
      var friendsCached = null;
      var friendsLastUpdateTime = 0;
      var connection = null;
      var myUid = null;

      chrome.browserAction.setIcon({ path: "facebook_icon.png" });
      chrome.browserAction.setTitle({ title: "Facebook chat" });

      chrome.tabs.onUpdated.addListener(onFacebookLogin);

      connection = new Strophe.Connection(boshServerURL + '/http-bind/');

      if (('invalidToken' in localStorage) && localStorage.invalidToken == 'false') {
        connection.facebookConnect(
                            localStorage.myUid + "@chat.facebook.com",
                            onConnect,
                            60,
                            1,
                            appId,
                            localStorage.accessToken
                            );
      }

      function onFacebookLogin(tabId, changeInfo, tab) {
        if (!localStorage.accessToken || localStorage.invalidToken) {
          if (changeInfo.url && changeInfo.url.indexOf(successURL) == 0) {
            var params = changeInfo.url.split('#');
            if (params.length > 1) {
              var paramsArray = params[1].split('&');
              for (var j in paramsArray) {
                var paramTuple = paramsArray[j].split('=');
                if (paramTuple[0] == 'access_token') {
                  localStorage.invalidToken = false;
                  localStorage.accessToken = paramTuple[1];

                  $.get(facebookAPIURL + '/me',
                      { 'access_token': localStorage.accessToken },
                      function (data) {
                        var pdata = JSON.parse(data);
                        if (!('error' in pdata)) {
                          localStorage.myUid = pdata.id;
                          connection.facebookConnect(
                              localStorage.myUid + "@chat.facebook.com",
                              onConnect,
                              60,
                              1,
                              appId,
                              localStorage.accessToken
                           );
                           chrome.extension.sendRequest(
                               { requestType: "serviceAvailable" });
                         } else
                           connection.disconnect();
                       }
                   );

                  break;
                }
              }
            }
            else {
              localStorage.clear();
              friendsCached = null;
              connection.disconnect();
              chrome.extension.sendRequest({ requestType: 'loggedOut' });
            }

            chrome.tabs.remove(tabId);
          }
        }
      }

      function onConnect(status) {
        if (status == Strophe.Status.CONNECTING) {
          console.log('Strophe is connecting.');
        } else if (status == Strophe.Status.CONNFAIL) {
          console.log('Strophe failed to connect.');
        } else if (status == Strophe.Status.DISCONNECTING) {
          console.log('Strophe is disconnecting.');
        } else if (status == Strophe.Status.DISCONNECTED) {
          console.log('Strophe is disconnected.');
        } else if (status == Strophe.Status.CONNECTED) {
          console.log('Strophe is connected.');
          console.log('Send a message to ' + connection.jid +
          ' to talk to me.');

          connection.addHandler(onMessage, null, 'message', null, null,  null);
          connection.send($pres().tree());
        }
      }

      function onMessage(msg) {
        var to = msg.getAttribute('to');
        var from = msg.getAttribute('from');
        var type = msg.getAttribute('type');
        var elems = msg.getElementsByTagName('body');

        if (type == "chat" && elems.length > 0) {
          var body = elems[0];
          var msgText = Strophe.getText(body);
          var msgDate = new Date();

          var fromUid = null;
          var matches = from.match(/\-?(\d+)@.*/);
          if (matches.length == 2) {
            fromUid = matches[1];
          }

          var found = false;
          var vs = chrome.extension.getViews();
          for (var i = 0; i < vs.length; ++i) {
            if (vs[i].location.hash.slice(1) == fromUid) {
              found = true;
              break;
            }
          }

          if (found) {
            chrome.extension.sendRequest({ requestType: 'newMessage', body: msgText,
              from: from, ts: msgDate });
          } else {
            saveToLocalStorage(fromUid,
              preprocessMessageText(msgText),
              msgDate,
              false);

            for (var i = 0; i < friendsCached.length; ++i) {
              if (friendsCached[i].uid == fromUid) {
                chrome.chromePrivate.newIncomingMessage(
                                   friendsCached[i].uid.toString(),
                                   friendsCached[i].name,
                                   friendsCached[i].online_presence,
                                   msgText);
                break;
              }
            }
          }

          console.log('I got a message from ' + from + ': ' +
          msgText);
        }

        // we must return true to keep the handler alive.
        // returning false would remove it after it finishes.
        return true;
      }

      function sendMessage(message, uidTo) {
        var to = '-' + uidTo + "@chat.facebook.com";

        if(message && to){
          var reply = $msg({
            to: to,
            type: 'chat'
          })
          .cnode(Strophe.xmlElement('body', message));
          connection.send(reply.tree());

          console.log('I sent ' + to + ': ' + message);
        }
      }

      function openAuthWindow(appId, redirectUri) {
        var url = "https://www.facebook.com/dialog/oauth?client_id=" + appId +
            "&response_type=token&redirect_uri=" + redirectUri +
            '&display=popup' +
            '&scope=xmpp_login,offline_access,' +
              'user_online_presence,friends_online_presence';

        window.open(url, 'facebookAuthWindow',
            'height=580,width=400,toolbar=no,directories=no,status=no,' +
            'menubar=no,scrollbars=no,resizable=no,modal=yes');
      }

      chrome.extension.onRequest.addListener(function (request, sender, sendResponse) {
        if (!request.requestType)
          return;

        if (request.requestType == 'getFriendList') {
          if (Date.now() - friendsLastUpdateTime >= 1 * 60 * 1000 ||
              !friendsCached)
            getFriendList();
          else
            friendListSent(friendsCached);
        }
        else if (request.requestType == 'setAccessToken') {
          localStorage.accessToken = request.accessToken;
          sendResponse.call(window);
          chrome.extension.sendRequest({ requestType: "serviceAvailable" });
        }
        else if (request.requestType == 'login') {
          openAuthWindow(appId, successURL);
        }
        else if (request.requestType == 'loggedOut') {

        }
        else if (request.requestType == "sendMessage") {
          sendMessage(request.message, request.uidTo);
        }
      });

      function getFqlQueryUrl(query) {
        var fqlUrl = 'https://api.facebook.com/method/fql.query?query=' +
              escape(query) + '&format=json' +
              '&access_token=' + localStorage.accessToken;
        return fqlUrl;
      }

      function friendListSent(obj) {
        chrome.extension.sendRequest({ requestType: 'sentFriendList',
                                       data: obj });
      }

      function getFriendList() {
        if (!localStorage.accessToken) {
          // send error through callback
          friendListSent({ error: 'Not authenticated to use' +
                                         ' Facebook services.' });
        }

        var friendListQuery =
            'SELECT uid, name, pic_square, online_presence' +
            ' FROM user WHERE uid IN' +
            ' (SELECT uid2 FROM friend WHERE uid1=me())';

        try {
          var req = new XMLHttpRequest();
          req.onreadystatechange = function () {
            if (req.readyState == 4) {
              if (req.status == 200) {
                resp = JSON.parse(req.responseText);
                if ('error_code' in resp) { // handle error first
                  var param = {};
                  param.error = 'FQL query failed: ' +
                    '(' + resp.error_code + ') ' +
                    (resp.error_msg ? resp.error_msg : 'No info.');
                  if (resp.error_code == FB.API_EC_PARAM_ACCESS_TOKEN) {
                    param.waitForService = true;
                    localStorage.invalidToken = true;
                    openAuthWindow(appId, successURL);
                  }

                  friendListSent(param);
                }
                else {
                  // return result, success
                  friendListSent(resp);
                  friendsCached = resp;
                  friendsLastUpdateTime = Date.now();
                }
              }
              else {
                friendListSent({ error: 'There was a problem' +
                      ' retrieving the data: ' + req.statusText });
              }

              req = null;
            }
          };
          req.open("GET", getFqlQueryUrl(friendListQuery), true);
          req.send(null);
        }
        catch(e) {
          // send error through callback
          friendListSent({ error: 'Can\'t connect to server: ' +
                            e.toString() });
        }
      }
 </script>
</head>
</html>
