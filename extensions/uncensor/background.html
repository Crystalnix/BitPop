<!DOCTYPE html>
<!--
 * Copyright (C) 2011 House of Life Property ltd.
 * Copyright (C) 2011 Crystalnix <vgachkaylo@crystalnix.com>
-->
<html>
  <head>
    <script type="text/javascript" src="parseuri.js"></script>
    <script>
      String.prototype.endsWith = function(suffix) {
          return this.indexOf(suffix, this.length - suffix.length) !== -1;
      };
    
      function initPrefs() {
        var prefs = {};
        prefs.shouldRedirect = true;
        prefs.showMessage = true;
        prefs.notifyUpdate = true;
        prefs.domainFilter = {
          "google.ru": "google.com",
          "torrents.ru": "rutracker.org",
          "torrentfinder.com": "torrentfinder.info",
          "re1ease.net": "scrrls.net",
          "1a": "a",
          "1b": "a",
          "1c": "a",
          "1d": "a",
          "1e": "a",
          "1f": "a",
          "1g": "a",
          "1h": "a",
          "1i": "a",
        };
        prefs.domainExceptions = {};
        
        localStorage.prefs = JSON.stringify(prefs);
      }
      
      var recent = {};
      recent.tabId = -1;
      recent.url = "";
      recent.timestamp = 0;
      
      // Called when the url of a tab changes.
      function redirectListener(tabId, changeInfo, tab) {
        var prefs = JSON.parse(localStorage.prefs);
        if (!prefs.shouldRedirect)
          return;
          
        var uri = parseUri(tab.url);
        for (var domain in prefs.domainFilter) {
          if (uri["host"].endsWith(domain)) {
            // in the next line, it will replace only first occurence of host string
            var newUri = tab.url.replace(domain, prefs.domainFilter[domain]);
                        
            chrome.tabs.update(tabId, {"url": newUri});
            if (prefs.showMessage &&
                !(tabId == recent.tabId && tab.url == recent.url && (Date.now() - recent.timestamp) < 500)
               ) {
              var notification = webkitNotifications.createNotification(
                '48uncensor.png',  // icon url - can be relative
                'Uncensor filter',  // notification title
                'You are being redirected to ' + newUri  // notification body text
              );
              notification.show();

              setTimeout(function() {
                notification.cancel();
              }, 5000);
            }
            
            recent.tabId = tabId;
            recent.url = tab.url;
            recent.timestamp = Date.now();
          }
        }
      };

//      if (!localStorage.prefs)
      initPrefs();
        
      // Listen for any changes to the URL of any tab.
      chrome.tabs.onUpdated.addListener(redirectListener);
    </script>
  </head>
</html>