<html>
<head>
  <script src="js/options.js"></script>
  <script src="js/desktop_notifications.js"></script>
  <script type="text/javascript" charset="utf-8">
    window.options.init();
    var current = window.options.current;

    var myUid = null;

    setTimeout(
      function() {
        if (!myUid) {
          chrome.extension.sendRequest(
            bitpop.CONTROLLER_EXTENSION_ID, 
            { type: 'getMyUid' },
            function(response) {
              myUid = response.id;

              DesktopNotifications.threads_unseen_before = [];
              DesktopNotifications.just_connected = true;

              DesktopNotifications.start(current.refreshTime); 
            }
          );
        }
      },
      5000); 
  </script>
</head>
<body>
  <script type="text/javascript" charset="utf-8">
    // chrome.extension.onRequestExternal.addListener(
    //     function (request, sender, sendResponse) {
    //       if (!request.type)
    //         return;

    //       if (request.type == 'accessTokenAvailable') {
    //         DesktopNotifications.start(current.refreshTime);
    //       }
    //       else if (request.type == 'loggedOut') {
    //         DesktopNotifications.stop();
    //       }
    //     }
    // );

    //DesktopNotifications.protocol = current.protocol;
    //DesktopNotifications.domain = current.domain;
    DesktopNotifications.controllerExtensionId = current.controllerExtensionId;
    DesktopNotifications.start(current.refreshTime);

    // chrome.browserAction.onClicked.addListener(function(tab) {
    //   chrome.windows.getCurrent(function(win) {

    //     chrome.tabs.getAllInWindow(win.id, function(tabs) {
    //       var found = false;
    //       for (var i = 0; i < tabs.length; i++) {
    //         if (tabs[i].url == 'http://www.facebook.com/messages' ||
    //             tabs[i].url == 'https://www.facebook.com/messages') {
    //           chrome.tabs.update(tabs[i].id, { selected: true });
    //           found = true;
    //           break;
    //         }
    //       }
    //       if (!found)
    //         chrome.tabs.create({ url: "http://www.facebook.com/messages" });
    //     });
    //   });
    // });

    chrome.extension.onRequestExternal.addListener(function (request, sender, sendResponse) {
      if (!request.type)
        return;

      if (request.type == 'myUidAvailable') {
        myUid = request.myUid;

        DesktopNotifications.threads_unseen_before = [];
        DesktopNotifications.just_connected = true;

        DesktopNotifications.start(current.refreshTime);

      } else if (request.type == 'newMessage') {
        DesktopNotifications.received_cache.push({ body: request.body,
                                                   from: request.from,
                                                   timestamp: new Date()
                                                   });
        if (DesktopNotifications.received_cache.length > 50)
          DesktopNotifications.received_cache.shift();
      } else if (request.type == 'loggedOut') {
        DesktopNotifications.just_connected = false;
      } else if (request.type == 'wentOffline' || request.type == 'chatIsIdle') {
        DesktopNotifications.threads_unseen_before = [];
        DesktopNotifications.just_connected = true;
        if (request.type == 'chatIsIdle')
          DesktopNotifications.stop();
      } else if (request.type == 'chatIsAvailable') {
        DesktopNotifications.start(current.refreshTime);
      }
    });

  </script>
</body>
</html>
