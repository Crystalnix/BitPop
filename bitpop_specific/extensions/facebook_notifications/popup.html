<html>
<head>
  <link rel="stylesheet" href="css/jewel-style.css" type="text/css" media="screen" charset="utf-8">
  <style type="text/css">
    /*html, body {
      width: 350px;
      height: 300px;
    }
    */
    .notification-content img {
      padding-right: 3px;
      vertical-align: middle;
    }
    .loading {
      position: relative;
      width: 100%;
      height: 200px;
      background-image: url('/images/indicator_white_large.gif');
      background-attachment:fixed;
      background-repeat:no-repeat;
      background-position: center center;
    }
  </style>
  <script src="js/jquery.min.js"></script>
  <script src="js/options.js"></script>
  <script src="js/humane.js"></script>
  <script type="text/javascript" charset="utf-8">
    var NUM_NOTIFICATIONS_SHOW = 5;

    window.options.init();
    var current = window.options.current;

    var DesktopNotifications =
      window.chrome.extension.getBackgroundPage().DesktopNotifications;

    function showError(errorMsg) {
      var newDom =
          //"<div class='empty-feed'>" +
          "<span>" + errorMsg + "</span>";// +
          //"</div>";
      $('#feed').empty();
      $('#feed').addClass('empty-feed');
      $('#feed').removeClass('loading');
      $('#feed').append(newDom);

      $('#footer').empty();
      var footerGoToOnClick = "onclick='chrome.tabs.create({ url: \"http://www.facebook.com/notifications\" })'";
      $('#footer').append("<div class='footer-item centered' " + footerGoToOnClick + ">Notifications</div>");
    }

function showNotifications(data) {
      $('#feed').removeClass('loading');
      $('#feed').empty();
      $('#footer').empty();

      var query1 = data[0].fql_result_set;
      var query2 = data[1].fql_result_set;

      var newDom = '';

      var footerGoToOnClick = "onclick='chrome.tabs.create({ url: \"http://www.facebook.com/notifications\" })'";
      if (query1.length == 0) {
        newDom =
          "<div class='empty-feed'>" +
          "  <span>No New Notifications.</span>" +
          "</div>";

        $('#footer').append("<div class='footer-item centered' " + footerGoToOnClick + ">Notifications</div>");
      } else
        $('#footer').append("<div class='footer-item centered' " + footerGoToOnClick + ">See All Notifications</div>");


      for (var i = 0; i < Math.min(query1.length, NUM_NOTIFICATIONS_SHOW); i++) {
        newDom += formatFeedItem(query1[i],
                                 findNameForUid(
                                   query1[i].sender_id,
                                   query2
                                   ),
                                 findPicForUid(
                                   query1[i].sender_id,
                                   query2
                                   )
                                );
      }

      $('#feed').append(newDom);

      var notificationIds = '';
      for (var i = 0; i < query1.length; i++) {
        if (query1[i].is_unread)
          notificationIds += query1[i].notification_id + ',';
      }

      if (notificationIds != '') {
        notificationIds = notificationIds.substring(0, notificationIds.length - 1);
        chrome.extension.sendRequest(current.controllerExtensionId,
            { type: 'restApiCall',
              method: 'notifications.markRead',
              params: { notification_ids: notificationIds }
            },
            function (response) {
              if (!response.error) {
                DesktopNotifications.fetchServerInfo(
                  DesktopNotifications.handleServerInfo,
                  DesktopNotifications.showInactiveIcon,
                  true // no_cache after clicking popup
                );
              }
            }
        );
      }
    }

    function findNameForUid(uid, data) {
      for (var i = 0; i < data.length; i++) {
        if (data[i].uid.toString() == uid.toString())
          return data[i].name;
      }
      return null;
    }

    function findPicForUid(uid, data) {
      for (var i = 0; i < data.length; i++) {
        if (data[i].uid.toString() == uid.toString())
          return data[i].pic_square;
      }
      return null;
    }

    function formatFeedItem(itemData, name, pic_url) {
      var template =
        "<div class='notification' onclick='chrome.tabs.create({ url: \"{{href}}\" })'>" +
          "<div class='left'>" +
            "<div class='user-photo'>" +
              "<img src='{{photoUrl}}' />" +
            "</div>" +
          "</div>" +
          "<div class='right'>" +
            "<div class='top'>" +
              "<div class='user-name'>" +
                "{{displayName}}" +
              "</div>" +
              "<div class='read-{{read}} time-since'>" +
                "{{time-since}}" +
              "</div>" +
            "</div>" +
            "<div class='bottom'>" +
              "<div class='notification-content'>" +
                "<img src='{{icon}}' />" +
                "{{title}}" +
              "</div>" +
            "</div>" +
          "</div>" +
          "</div>";
      template = template.replace('{{href}}', itemData.href);
      template = template.replace('{{photoUrl}}', pic_url);
      template = template.replace('{{displayName}}', name);
      template = template.replace('{{read}}',
        itemData.is_unread ? "false" : "true");
      template = template.replace('{{time-since}}',
        humane_date(ISODateString(new Date(itemData.created_time * 1000))));
      template = template.replace('{{icon}}', itemData.icon_url);
      template = template.replace('{{title}}', itemData.title_text);

      return template;
    }
  </script>
</head>
<body>
  <div id="header">
    <div class='title'>Notifications</div>
  </div>
  <div id="feed" class="loading"></div>
  <div id="footer"></div>
  <script type="text/javascript" charset="utf-8">
    var query1 = 'SELECT notification_id, recipient_id, sender_id, created_time, title_text, href, is_unread, icon_url ' +
                 'FROM notification ' +
                 'WHERE recipient_id=me() AND is_hidden=0';
    var query2 = 'SELECT uid, name, pic_square ' +
                 'FROM user ' +
                 'WHERE uid IN ' +
                 '(SELECT sender_id FROM #query1)';
    var query = JSON.stringify({ query1: query1, query2: query2 });

    chrome.extension.sendRequest(current.controllerExtensionId,
        {
          type: 'fqlQuery',
          query: query
        },
        function (response) {
          if (response.error)
            showError(response.error);
          else
            showNotifications(response);
        }
    );
  </script>
</body>
</html>
